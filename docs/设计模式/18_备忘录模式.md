## 背景故事

你正在开发一个文档编辑器，希望支持“撤销”功能。用户可以：

- 修改标题
- 编辑内容
- 格式化文字

用户每操作一次，就会生成一个新的状态。你希望：

- 用户点击“撤销”按钮时，系统能**恢复到之前某个状态**
- 又不能让外部代码**随意访问或修改对象内部状态**

这就需要**备忘录模式**：它允许你在不暴露对象内部细节的前提下，捕获并恢复其状态。

## 代码演示

备忘录（Memento）：记录对象状态

```cs
public class EditorMemento
{
    public string Content { get; }
    public EditorMemento(string content) => Content = content;
}
```

发起人（Originator）：创建和恢复备忘录

```cs
public class Editor
{
    private string _content = "";

    public void Write(string text)
    {
        _content += text;
    }

    public string Show() => _content;

    public EditorMemento Save() => new EditorMemento(_content);

    public void Restore(EditorMemento memento)
    {
        _content = memento.Content;
    }
}
```

负责人（Caretaker）：管理备忘录历史

```cs
public class History
{
    private Stack<EditorMemento> _stack = new();

    public void Push(EditorMemento memento) => _stack.Push(memento);
    public EditorMemento Pop() => _stack.Pop();
}
```

客户端使用示例

```cs
class Program
{
    static void Main()
    {
        var editor = new Editor();
        var history = new History();

        editor.Write("Hello ");
        history.Push(editor.Save());

        editor.Write("World!");
        history.Push(editor.Save());

        Console.WriteLine(editor.Show()); // Hello World!

        editor.Restore(history.Pop());
        Console.WriteLine(editor.Show()); // Hello 

        editor.Restore(history.Pop());
        Console.WriteLine(editor.Show()); // 
    }
}
```

## 定义

**备忘录模式（Memento）**：在不破坏封装的前提下，捕获对象的内部状态，并在之后将对象恢复到之前的状态。

<import filepath="./UML/18.puml" />

## 应用场景

- **编辑器撤销**功能（文档、图形、音频等）
- **游戏存档/读档**
- **对象状态快照保存**（配置变更、流程回滚）
- **事务回滚机制**（如数据库中间状态回退）

## 总结

优点

- **封装性好**：外部无法访问对象内部状态
- **易于恢复**：可随时回退到之前的某个状态
- **历史可控**：可保存多个历史状态用于撤销、重做

缺点

- **内存开销大**：频繁保存快照，尤其是大对象时资源消耗高
- **不支持部分恢复**：每次都是全量保存，无法精细恢复
## 背景故事

你正在开发一个游戏编辑器，支持用户执行如下操作：

- 移动单位
- 改变颜色
- 撤销操作
- 批量执行宏命令

这时你需要命令模式：**将请求封装成对象，使你能参数化客户端、记录请求、支持撤销操作等行为。**

## 代码演示

命令接口

```cs
public interface ICommand
{
    void Execute();
    void Undo(); // 可选
}
```

具体命令类

```cs
public class MoveCommand : ICommand
{
    private readonly Unit _unit;
    private readonly int _dx, _dy;

    public MoveCommand(Unit unit, int dx, int dy)
    {
        _unit = unit;
        _dx = dx;
        _dy = dy;
    }

    public void Execute() => _unit.Move(_dx, _dy);
    public void Undo() => _unit.Move(-_dx, -_dy);
}
```

```cs
public class ColorCommand : ICommand
{
    private readonly Unit _unit;
    private readonly string _color;
    private string _previous;

    public ColorCommand(Unit unit, string color)
    {
        _unit = unit;
        _color = color;
    }

    public void Execute()
    {
        _previous = _unit.Color;
        _unit.Color = _color;
        Console.WriteLine($"颜色改为 {_color}");
    }

    public void Undo()
    {
        _unit.Color = _previous;
        Console.WriteLine($"撤销颜色，恢复为 {_previous}");
    }
}
```

接收者（Receiver）

```cs
public class Unit
{
    public int X { get; private set; }
    public int Y { get; private set; }
    public string Color { get; set; } = "white";

    public void Move(int dx, int dy)
    {
        X += dx;
        Y += dy;
        Console.WriteLine($"单位移动到: ({X},{Y})");
    }
}
```

调用者（Invoker）

```cs
public class CommandInvoker
{
    private readonly Stack<ICommand> history = new();

    public void Execute(ICommand command)
    {
        command.Execute();
        history.Push(command);
    }

    public void Undo()
    {
        if (history.Count > 0)
        {
            var last = history.Pop();
            last.Undo();
        }
    }
}
```

客户端示例

```cs
class Program
{
    static void Main()
    {
        var unit = new Unit();
        var invoker = new CommandInvoker();

        var move = new MoveCommand(unit, 5, 0);
        var paint = new ColorCommand(unit, "red");

        invoker.Execute(move);
        invoker.Execute(paint);

        invoker.Undo(); // 撤销颜色
        invoker.Undo(); // 撤销移动
    }
}
```

## 定义

> **命令模式（Command）**：将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化，对请求排队或记录请求日志，以及支持可撤销的操作。

<import filepath="./UML/14.puml" />

|角色|职责|
|---|---|
|Command（命令）|声明执行操作的接口|
|ConcreteCommand|封装实际请求与接收者逻辑|
|Receiver（接收者）|真正执行操作的类（如单位、设备）|
|Invoker（调用者）|触发命令的对象（如按钮/宏录制器）|
|Client（客户端）|创建命令对象并配置调用者与接收者的关系|

## 应用场景

- **操作撤销与恢复（如编辑器）**
- **事务记录与日志回滚（数据库事务）**
- **命令队列、批量宏操作（游戏脚本、批处理）**
- **GUI事件系统、消息总线**

## 总结

优点

- **解耦调用者与接收者**
- **支持撤销/重做**
- **支持请求排队与宏命令**
- **支持日志记录**

缺点

- 类数量增多（每个操作需创建一个命令类）
- 某些简单命令实现显得冗余